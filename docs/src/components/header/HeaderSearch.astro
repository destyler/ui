---
/**
 * Header Search — icon-only trigger button + fullscreen dialog with Pagefind.
 */
---

<!-- Search icon button -->
<button
  type="button"
  id="ds-search-trigger"
  class="flex items-center rounded-md! justify-center w-8 h-8 border border-transparent bg-transparent text-$sl-color-gray-3 cursor-pointer p-0 no-underline transition-[color,border-color] duration-150 hover:(text-$sl-color-text border-$sl-color-hairline)"
  aria-label="Search (⌘K)"
>
  <span class="i-tabler-search !w-4 !h-4" aria-hidden="true" />
</button>

<!-- Search dialog -->
<dialog id="ds-search-dialog" class="fixed inset-0 w-full max-w-full h-full max-h-full m-0 p-0 border-none bg-transparent z-50 backdrop:bg-black/60 backdrop:backdrop-blur-sm">
  <div class="absolute top-[10%] left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-144 bg-$sl-color-bg border border-$sl-color-hairline shadow-2xl flex flex-col max-h-[70vh] overflow-hidden">
    <div class="flex items-center gap-3 px-4 py-3 border-b border-$sl-color-hairline text-$sl-color-gray-3">
      <span class="i-tabler-search !w-3.5 !h-3.5 shrink-0" aria-hidden="true" />
      <input
        type="search"
        id="ds-search-input"
        placeholder="Search documentation…"
        autocomplete="off"
        class="flex-1 border-none bg-transparent text-$sl-color-text font-display text-[0.9375rem] font-500 tracking-[-0.01em] outline-none placeholder:text-$sl-color-gray-4"
      />
      <button
        type="button"
        id="ds-search-close"
        class="flex items-center border border-$sl-color-hairline bg-transparent text-$sl-color-gray-4 cursor-pointer px-1.5 py-0.5 font-code text-[0.6875rem] font-600 tracking-[0.05em] transition-[border-color] duration-150 hover:border-$sl-color-gray-4"
        aria-label="Close search"
      >
        <kbd>ESC</kbd>
      </button>
    </div>
    <div id="ds-search-results" class="overflow-y-auto p-2"></div>
  </div>
</dialog>

<style>
  :global(.ds-result) {
    display: block;
    padding: 0.75rem;
    color: var(--sl-color-text);
    text-decoration: none;
    border-bottom: 1px solid var(--sl-color-hairline);
    transition: background-color 100ms;
  }
  :global(.ds-result:last-child) { border-bottom: none; }
  :global(.ds-result:hover) { background-color: var(--sl-color-gray-7); }
  :global(.ds-result-title) {
    display: block;
    font-family: "Inter Tight", "Inter", system-ui, sans-serif;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: -0.01em;
    margin-bottom: 0.25rem;
  }
  :global(.ds-result-excerpt) {
    display: block;
    font-size: 0.8125rem;
    color: var(--sl-color-gray-3);
    line-height: 1.5;
  }
  :global(.ds-result-excerpt mark) {
    background-color: var(--sl-color-accent-low);
    color: var(--sl-color-accent);
    padding: 0.05em 0.1em;
  }
  :global(.ds-search-empty) {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--sl-color-gray-4);
    font-family: "Inter Tight", "Inter", system-ui, sans-serif;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.02em;
  }
</style>

<script>
  const searchTrigger = document.getElementById('ds-search-trigger')!;
  const searchDialog = document.getElementById('ds-search-dialog') as HTMLDialogElement;
  const searchInput = document.getElementById('ds-search-input') as HTMLInputElement;
  const searchResults = document.getElementById('ds-search-results')!;
  const searchClose = document.getElementById('ds-search-close')!;

  let pagefind: any;

  async function loadPagefind() {
    if (pagefind) return true;
    try {
      const pagefindPath = `${window.location.origin}/_pagefind/pagefind.js`;
      pagefind = await import(pagefindPath);
      await pagefind.options?.({ excerptLength: 15 });
      return true;
    } catch {
      searchResults.innerHTML =
        '<p class="ds-search-empty">Search is not available in development mode.<br/>Run a production build to enable search.</p>';
      return false;
    }
  }

  async function performSearch(query: string) {
    if (!pagefind || !query.trim()) {
      searchResults.innerHTML = '';
      return;
    }
    const search = await pagefind.search(query);
    const data = await Promise.all(
      search.results.slice(0, 12).map((r: any) => r.data())
    );
    if (data.length === 0) {
      searchResults.innerHTML = '<p class="ds-search-empty">No results found.</p>';
      return;
    }
    searchResults.innerHTML = data
      .map(
        (r: any) => `
        <a href="${r.url}" class="ds-result">
          <span class="ds-result-title">${r.meta?.title || r.url}</span>
          <span class="ds-result-excerpt">${r.excerpt || ''}</span>
        </a>`
      )
      .join('');
  }

  async function openSearch() {
    searchDialog.showModal();
    await loadPagefind();
    searchInput.value = '';
    searchResults.innerHTML = '';
    searchInput.focus();
  }

  searchTrigger.addEventListener('click', openSearch);
  searchClose.addEventListener('click', () => searchDialog.close());

  searchDialog.addEventListener('click', (e) => {
    if (e.target === searchDialog) searchDialog.close();
  });

  searchInput.addEventListener('input', () => performSearch(searchInput.value));

  searchResults.addEventListener('click', (e) => {
    const link = (e.target as HTMLElement).closest('a');
    if (link) searchDialog.close();
  });

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (searchDialog.open) {
        searchDialog.close();
      } else {
        openSearch();
      }
    }
  });
</script>
