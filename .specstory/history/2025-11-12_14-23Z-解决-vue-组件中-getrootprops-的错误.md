<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- vscode Session c3f14a1e-b462-47fe-9920-6a8d848939ee (2025-11-12 14:23Z) -->

# 解决 Vue 组件中 getRootProps 的错误 (2025-11-12 14:23Z)

_**User (2025-11-12 14:24Z)**_

现在出现了这个问题

```
TypeError: Cannot read properties of undefined (reading 'getRootProps')
    at Proxy._sfc_render (http://localhost:6006/src/components/collapsible/components/RootProvider.vue:23:86)
    at renderComponentRoot (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:8965:17)
    at ReactiveEffect.componentUpdateFn [as fn] (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7848:26)
    at ReactiveEffect.run (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:750:19)
    at updateComponent (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7708:18)
    at processComponent (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7642:7)
    at patch (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7135:11)
    at patchBlockChildren (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7501:7)
    at processFragment (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7579:9)
    at patch (http://localhost:6006/node_modules/.cache/storybook/b3e77991ec8863a9bb25945f250554e681cb43b2f5fdb88424ffc16b145c4a2b/sb-vite/deps/chunk-HYFIWIMW.js?v=4040a3b3:7109:9)
    ```

---

_**Agent (model copilot/claude-sonnet-4.5)**_

我看到问题了。错误显示 `collapsible.getRootProps` 为 undefined,这是因为在模板中使用 `collapsible.getRootProps()` 时,`collapsible` 可能还没有正确初始化。

让我先查看一下相关的代码来了解完整的上下文: 现在我明白问题了。`RootProvider.vue` 组件中,`collapsible` 是一个 `computed` 属性,它的值是 `props.value`,但这个 `props.value` 本身就应该是一个 `ComputedRef<UseCollapsibleReturn>`。问题是在模板中直接使用 `collapsible.getRootProps()` 时,需要先解包这个 computed。

修复方法是在模板中使用 `collapsible` 时,它已经是一个 computed 返回的值,所以应该直接访问 `.value`: 
```

```
我需要查看 `CollapsibleProvider` 的定义来了解正确的类型: 现在让我检查 `createContext` 的实现: 现在我明白了。`CollapsibleProvider` 期望接收 `UseCollapsibleReturn`,而 `UseCollapsibleReturn` 本身就是 `ComputedRef<Collapsible>`。所以问题是 `props.value` 已经是一个 `ComputedRef`,我们应该直接传递它,而不是包装在函数中。修改如下: 
```

```
我理解了问题所在。根据类型定义,`RootProviderProps` 中的 `value` 是 `UnwrapRef<UseCollapsibleReturn>`,这意味着它已经被解包了。但是 `CollapsibleProvider` 期望的是 `UseCollapsibleReturn`(也就是 `ComputedRef<Collapsible>`)。

我们需要将解包后的值重新包装成 `computed`: 
```

```
完成!现在代码应该可以正常工作了。问题的根本原因是:

1. **`RootProviderProps.value`** 的类型是 `UnwrapRef<UseCollapsibleReturn>`,这意味着它是解包后的 `Collapsible` 对象
2. **`CollapsibleProvider`** 期望接收 `UseCollapsibleReturn`(即 `ComputedRef<Collapsible>`)
3. 模板中 `props.value.getRootProps()` 可以直接访问,因为 Vue 会自动解包 props 中的 ref

所以最终的解决方案是:
- 使用 `computed(() => props.value)` 将解包后的值重新包装成 computed,以满足 `CollapsibleProvider` 的类型要求
- 在模板中直接使用 `props.value.getRootProps()`,因为 `props.value` 已经是解包后的对象

这样既满足了类型检查,也确保了运行时 `getRootProps()` 方法可以正确调用。

---

